<?xml version="1.0" encoding="UTF-8"?>
 
<databaseChangeLog
	xmlns="http://www.liquibase.org/xml/ns/dbchangelog/1.7"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog/1.7
	http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.7.xsd">
	<preConditions>            
		<or>
			<dbms type="oracle" />                     
			<dbms type="mysql" />                     
		</or>
	</preConditions>                                       
	<changeSet id="1" author="ssaksa">        
		<comment>Need to have at least one changeset to allow tagging to work.</comment>
		<sql>select now()</sql>
	</changeSet>
    <changeSet id="1.1" author="tandrews">
        <comment>Updates DB for v1.1</comment>
        <sqlFile path="@db-upgrade.run.dir@/upgrade-1.1.sql"/>
    </changeSet>
    <changeSet id="1.1.1" author="nnguyen">
        <comment>Updates DB for v1.1.1</comment>
        <sqlFile path="@db-upgrade.run.dir@/upgrade-1.1.1.sql"/>
    </changeSet>
    <changeSet id="1.1.2" author="tandrews">
        <comment>Adds column "LAST_MODIFIED_BY_USER_ID" to STUDY_CONFIGURATION table</comment>
        <sqlFile path="@db-upgrade.run.dir@/upgrade-1.1.2.sql"/>
    </changeSet>
    <changeSet id="1.1.3" author="tandrews">
        <comment>Adds column "LAST_MODIFIED_DATE" to STUDY_CONFIGURATION table</comment>
        <sqlFile path="@db-upgrade.run.dir@/upgrade-1.1.3.sql"/>
    </changeSet>
    <changeSet id="1.1.4" author="nnguyen">
        <comment>Adds COPY_NUMBER_SINGLE_DATA_FILE to GENOMIC_DATA_SOURCE_CONFIGURATION table</comment>
        <sqlFile path="@db-upgrade.run.dir@/upgrade-1.1.4.sql"/>
    </changeSet>
    <changeSet id="1.1.4.1" author="nnguyen">
        <comment>Sets default value for COPY_NUMBER_SINGLE_DATA_FILE</comment>
        <sqlFile path="@db-upgrade.run.dir@/upgrade-1.1.4.1.sql"/>
    </changeSet>
    <changeSet id="1.1.5" author="nnguyen">
        <comment>Sets default value for SHOW_IN_BROWSE</comment>
        <sqlFile path="@db-upgrade.run.dir@/upgrade-1.1.5.sql"/>
    </changeSet>
    <changeSet id="1.1.6" author="tandrews">
        <comment>Adds EXTERNAL_LINK_LIST and EXTERNAL_LINK tables.</comment>
        <sqlFile path="@db-upgrade.run.dir@/upgrade-1.1.6.sql"/>
    </changeSet>
    <changeSet id="1.1.7" author="tandrews">
        <comment>Adds CATEGORY field to EXTERNAL_LINK table.</comment>
        <sqlFile path="@db-upgrade.run.dir@/upgrade-1.1.7.sql"/>
    </changeSet>
    <changeSet id="1.1.8" author="tandrews">
        <comment>Updates the sizes of the GENE_SYMBOL columns to 1200.</comment>
        <sqlFile path="@db-upgrade.run.dir@/upgrade-1.1.8.sql"/>
    </changeSet>
    <changeSet id="1.1.9" author="nguyennh">
        <comment>Add SAMPLE_MAPPING_FILE_PATH to GENOMIC_DATA_SOURCE_CONFIGURATION table.</comment>
        <sqlFile path="@db-upgrade.run.dir@/upgrade-1.1.9.sql"/>
    </changeSet>
    <changeSet id="1.1.10" author="tandrews">
        <comment>Update database to use new SUBJECT_LIST/SUBJECT_LIST_CRITERION.</comment>
        <sqlFile path="@db-upgrade.run.dir@/upgrade-1.1.10.sql"/>
    </changeSet>
    <changeSet id="1.1.11" author="nguyennh">
        <comment>Add METHOD to ABSTRACT_PERSISTED_ANALYSIS_JOB table.</comment>
        <sqlFile path="@db-upgrade.run.dir@/upgrade-1.1.11.sql"/>
    </changeSet>
    <changeSet id="1.1.12" author="nguyennh">
        <comment>Rename AFFYMETRIX_DNA_ANALYSIS and AGILENT_DNA_ANALYSIS in the PLATFORM_CONFIGURATION table.</comment>
        <sqlFile path="@db-upgrade.run.dir@/upgrade-1.1.12.sql"/>
    </changeSet>
    <changeSet id="1.1.13" author="nguyennh">
        <comment>Change AFFYMETRIX_SNP to AFFYMETRIX_COPY_NUMBER in the PLATFORM_CONFIGURATION table.</comment>
        <sqlFile path="@db-upgrade.run.dir@/upgrade-1.1.13.sql"/>
    </changeSet>
    <changeSet id="1.1.14" author="tandrews">
        <comment>Adding ANNOTATION_GROUP and all the appropriate associations with the new change to annotation definitions.</comment>
        <sqlFile path="@db-upgrade.run.dir@/upgrade-1.1.14.sql"/>
    </changeSet>
    <changeSet id="1.1.15" author="tandrews">
        <comment>Deleting unused AFD's and set them all to ANNOTATION</comment>
        <sqlFile path="@db-upgrade.run.dir@/upgrade-1.1.15.sql"/>
    </changeSet>
    <changeSet id="1.1.15.1" author="tandrews">
        <sql>DROP PROCEDURE IF EXISTS create_afd_for_identifier_cols;</sql>
		<sql splitStatements="false" stripComments="false">
            <![CDATA[
		CREATE PROCEDURE create_afd_for_identifier_cols()
		BEGIN
		DECLARE cur_end INT;
		DECLARE fc_id, afd_id LONG;
		DECLARE fc_name VARCHAR(255);
		DECLARE cur_1 CURSOR FOR SELECT f.id, f.name FROM file_column f, annotation_file af where  af.identifier_column_id = f.id;
		DECLARE CONTINUE HANDLER FOR NOT FOUND
		  SET cur_end = 1;
		
		open cur_1;
		fc_loop : LOOP
		  FETCH cur_1 INTO fc_id, fc_name;
		
		  IF cur_end = 1 THEN
		    LEAVE fc_loop;
		  END IF;
		
		  INSERT into ANNOTATION_FIELD_DESCRIPTOR (name,type,shown_in_browse) VALUES (fc_name, 'IDENTIFIER', '1');
		  UPDATE file_column SET ANNOTATION_FIELD_DESCRIPTOR_ID = (select max(id) from annotation_field_descriptor) where ID = fc_id;
		
		END LOOP fc_loop;
		CLOSE cur_1;
		
		END;

        ]]>
        </sql>
        <sql>CALL create_afd_for_identifier_cols();</sql>
        <comment>Creates Identifier AFD's for the identifier columns (using a stored procedure).</comment>
    </changeSet>
    <changeSet id="1.1.15.2" author="tandrews">
        <comment>Delete the columns IDENTIFIER_COLUMN_ID and TIMEPOINT_COLUMN_ID out of ANNOTATION_FILE</comment>
        <sqlFile path="@db-upgrade.run.dir@/upgrade-1.1.15.2.sql"/>
    </changeSet>
</databaseChangeLog>
