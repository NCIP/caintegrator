<!-- *********************************************************************** -->
<!-- ** PROJECT:   caIntegrator 2                                         ** -->
<!-- *********************************************************************** -->

<project name="caintegrator2" default="continuous-integration" basedir="." 
	xmlns:ivy="antlib:org.apache.ivy.ant"
	xmlns="antlib:org.apache.tools.ant"
	xmlns:cs="antlib:com.puppycrawl.tools.checkstyle"
	>

    <!-- ******************************************************************* -->
    <!-- ** PROPERTIES / PATHS                                            ** -->
    <!-- ******************************************************************* -->

    <!-- Main -->
    <property name="root.dir" location="${basedir}/../.." />
    <property name="docs.dir" location="${root.dir}/docs" />
    <property name="software.dir" location=".." />
    <property name="build.dir" location="${software.dir}/caintegrator2-war" />
    <property name="lib.dir" location="${software.dir}/lib" />
    <property name="external.runtime.lib.dir" location="${lib.dir}/external-runtime" />
    <property name="build.lib.dir" location="${software.dir}/lib" />
    <property name="resource.dir" location="${software.dir}/common" />
    <property name="target.dir" location="${build.dir}/target" />
    <property name="common.dir" value="${software.dir}/common"/>

    <!-- Environment properties -->
    <property environment="env" />
    <property file="${build.dir}/local.properties" />
    <property file="${build.dir}/default.properties" />
    <property file="${software.dir}/build/project.properties"/>
    <property file="${envpropertyfile}" />

    <!-- Filtersets -->
    <filterset id="caintegrator2.filterset" onmissingfiltersfile="warn">
        <filtersfile file="${build.dir}/local.properties" />
        <filtersfile file="${build.dir}/default.properties" />
        <filtersfile file="${envpropertyfile}" />
    </filterset>

    <!-- Report properties -->
    <property name="reports.dir" value="${software.dir}/target/reports"/>
    <property name="reports.simian.dir" value="${reports.dir}/simian"/>
    <property name="reports.pmd.dir" value="${reports.dir}/pmd"/>
    <property name="reports.checkstyle.dir" value="${reports.dir}/checkstyle"/>
    <property name="reports.javancss.dir" value="${reports.dir}/javancss"/>
    <property name="reports.findbugs.dir" value="${reports.dir}/findbugs"/>

    <!-- ******************************************************************* -->
    <!-- ** BUILD / TASKDEFS                                              ** -->
    <!-- ******************************************************************* -->
    <!-- Checkstyle -->
    <property name="checkstyle.config" location="${resource.dir}/checkstyle/caintegrator2_checks.xml" />
    
    <!-- Hibernate -->

    <path id="hibernatetool.classpath">
        <fileset dir="${lib.dir}/hibernatetool">
            <include name="commons-logging-1.0.4.jar" />
            <include name="ejb3-persistence-1.0.1.jar" />
            <include name="hibernate-annotations-1.0.jar" />
            <include name="hibernate-commons-annotations-3.0.0.GA.jar" />
            <include name="hibernate-tools-3.2.2.beta1.jar" />
            <include name="mysql-connector-java-5.0.5.jar" />
            <include name="antlr-2.7.6.jar" />
            <include name="asm-1.5.3.jar" />
            <include name="c3p0-0.9.0.jar" />
            <include name="cglib-2.1_3.jar" />
            <include name="commons-collections-3.2.jar" />
            <include name="ehcache-1.2.4.jar" />
            <include name="hibernate-3.2.0.ga.jar" />
            <include name="freemarker-2.3.8.jar" />            
            <include name="dom4j-1.6.1.jar" />
        </fileset>
    </path>
    <taskdef name="hibernatetool" classname="org.hibernate.tool.ant.HibernateToolTask" classpathref="hibernatetool.classpath" />

    <!-- BDA -->
    <property name="bda-utils.dir" location="${software.dir}/target/bda-utils" />

    <mkdir dir="${build.lib.dir}" />
    <ant inheritAll="false" inheritRefs="false" dir="${software.dir}/common/bda-download"
	    antfile="bda-ivy-build.xml" target="retrieve-bda">
        <property name="bda-utils.dir" location="${bda-utils.dir}" />
        <property name="lib.dir" location="${build.lib.dir}" />
        <property name="software.dir" location="${software.dir}" />
	<property name="bda.local.repo.dir" location="${software.dir}/../../bda-local-ivy-repo" />
	<property name="bda.version" value="${bda.version}"/>
    </ant>

    <import file="${bda-utils.dir}/bda-build-utils-${bda.version}.xml" />

    <!-- Cobertura -->
    <property name="cobertura.dir" location="${reports.dir}/cobertura" />
    <property name="cobertura.file" location="${cobertura.dir}/cobertura.ser" />
    <property name="cobertura-functional.file" location="${cobertura.dir}/cobertura-functional.ser" />
    <property name="cobertura-merged.file" location="${cobertura.dir}/cobertura-merged.ser" />

    <!-- ******************************************************************* -->
    <!-- ** IVY TARGETS AND DEPENDENCY PATHS                              ** -->
    <!-- ******************************************************************* -->

    <property name="ivy.jar" location="${build.lib.dir}/ivy-2.0.0-beta2.jar" />

    <property name="ivy.settings.file" location="${common.dir}/ivysettings.xml" />
    <property name="ivy.def.file" location="ivy-caintegrator2.xml" />
    <property name="local.repo.dir" location="${software.dir}/local-ivy-repo" />

    <taskdef resource="org/apache/ivy/ant/antlib.xml" uri="antlib:org.apache.ivy.ant" classpath="${ivy.jar}" />

    <property name="caintegrator2.war.compile.lib.dir" location="${lib.dir}/caintegrator2-compile"/>
    <property name="caintegrator2.war.runtime.lib.dir" location="${lib.dir}/caintegrator2-runtime"/>

    <property name="acceptance.lib.dir" location="${lib.dir}/test-acceptance"/>
    <property name="checkstyle.lib.dir" location="${lib.dir}/test-checkstyle"/>
    <property name="cobertura.lib.dir" location="${lib.dir}/test-cobertura"/>
    <property name="findbugs.lib.dir" location="${lib.dir}/test-findbugs"/>
    <property name="javancss.lib.dir" location="${lib.dir}/test-javancss"/>
    <property name="junit.lib.dir" location="${lib.dir}/test-junit"/>
    <property name="pmd.lib.dir" location="${lib.dir}/test-pmd"/>
    <property name="selenium.lib.dir" location="${lib.dir}/test-selenium"/>
    <property name="simian.lib.dir" location="${lib.dir}/test-simian"/>

    <target name="ivy:init">
        <property name="ivy.dep.file" value="${ivy.def.file}"/>
        <ivy:settings file="${ivy.settings.file}" override="true" />
    </target>
    
    <target name="ivy:clean" depends="clean:dependencies" description="Clean">
        <ivy:settings file="${ivy.settings.file}" />
        <ivy:cleancache />
    </target>
    
    <target name="clean:dependencies">
        <delete dir="${caintegrator2.war.compile.lib.dir}" />
        <delete dir="${caintegrator2.war.runtime.lib.dir}" />
        <delete dir="${acceptance.lib.dir}" />
        <delete dir="${checkstyle.lib.dir}" />
        <delete dir="${cobertura.lib.dir}" />
        <delete dir="${findbugs.lib.dir}" />
        <delete dir="${javancss.lib.dir}" />
        <delete dir="${junit.lib.dir}" />
        <delete dir="${pmd.lib.dir}" />
        <delete dir="${selenium.lib.dir}" />
        <delete dir="${simian.lib.dir}" />
    </target>

    <target name="ivy:setup" depends="ivy:setup-runtime, 
        ivy:setup-compile,
        ivy:setup-test,
        ivy:setup-static-analysis" 
        description="Updates the local ivy repository for all build and test dependencies."/>
    
    <target name="ivy:setup-runtime" depends="ivy:init">
        <ivy:resolve refresh="true" conf="runtime" />
        <ivy:retrieve pattern="${lib.dir}/caintegrator2-[conf]/[artifact]-[revision].[ext]" conf="runtime" />
    </target>

    <target name="ivy:setup-compile" depends="ivy:init">
        <ivy:resolve refresh="true" conf="compile" />
        <ivy:retrieve pattern="${lib.dir}/caintegrator2-[conf]/[artifact]-[revision].[ext]" conf="compile" />
    </target>
            
    <target name="ivy:setup-test" depends="ivy:init">
        <ivy:resolve refresh="true" conf="test-selenium" />
        <ivy:retrieve pattern="${lib.dir}/[conf]/[artifact]-[revision].[ext]" conf="test-selenium" />
        <path id="selenium.classpath">
            <fileset dir="${selenium.lib.dir}">
                <include name="*.jar" />
            </fileset>
        </path>
        <ivy:resolve refresh="true" conf="test-junit" />
        <ivy:retrieve pattern="${lib.dir}/[conf]/[artifact]-[revision].[ext]" conf="test-junit" />
        <path id="junit.classpath">
            <fileset dir="${junit.lib.dir}">
                <include name="*.jar" />
            </fileset>
        </path>
        <ivy:resolve refresh="true" conf="test-cobertura" />
        <ivy:retrieve pattern="${lib.dir}/[conf]/[artifact]-[revision].[ext]" conf="test-cobertura" />
        <path id="cobertura.classpath">
            <fileset dir="${cobertura.lib.dir}">
                <include name="*.jar" />
            </fileset>
        </path>
        <taskdef classpathref="cobertura.classpath" resource="tasks.properties" />
    </target>

    <target name="ivy:setup-static-analysis" depends="ivy:init">
        <ivy:resolve refresh="true" conf="test-javancss" />
        <ivy:retrieve pattern="${lib.dir}/[conf]/[artifact]-[revision].[ext]" conf="test-javancss" />
        <path id="javancss.classpath">
            <fileset dir="${lib.dir}/test-javancss">
                <include name="*.jar" />
            </fileset>
        </path>
        <ivy:resolve refresh="true" conf="test-checkstyle" />
        <ivy:retrieve pattern="${lib.dir}/[conf]/[artifact]-[revision].[ext]" conf="test-checkstyle" />
        <path id="project.test.checkstyle.classpath">
            <fileset dir="${lib.dir}/test-checkstyle">
                <include name="*.jar" />
            </fileset>
        </path>
        <ivy:resolve refresh="true" conf="test-pmd" />
        <ivy:retrieve pattern="${lib.dir}/[conf]/[artifact]-[revision].[ext]" conf="test-pmd" />
        <path id="project.test.pmd.classpath">
            <fileset dir="${lib.dir}/test-pmd">
                <include name="*.jar" />
            </fileset>
        </path>
        <ivy:resolve refresh="true" conf="test-simian" />
        <ivy:retrieve pattern="${lib.dir}/[conf]/[artifact]-[revision].[ext]" conf="test-simian" />
        <path id="project.test.simian.classpath">
            <fileset dir="${lib.dir}/test-simian">
                <include name="*.jar" />
            </fileset>
        </path>
    </target>


    <!-- ******************************************************************* -->
    <!-- ** MAIN TARGETS                                                  ** -->
    <!-- ******************************************************************* -->

    <target name="continuous-integration" 
        depends="clean,build,static-analysis,test:unit" 
        description="Cleans, builds, checks and tests the codebase. This should be run prior to every commit." />

    <target name="nightly-build" 
        depends="continuous-integration,database:reinitialize,test:integration" 
        description="Builds and deploys caIntegrator 2 and performs the complete suite of tests." />

    <target name="clean" 
        depends="clean:caintegrator2.war,
        clean:dependencies,
        clean:reports"
        description="Removes all generated artifacts from the working directory." />

    <target name="build" 
        depends="caintegrator2.war"
        description="Compiles all production source code and assembles artifacts." />

    <target name="database" 
        depends="database:reinitialize"
        description="Drops any exisisting instance of the caintegrator2 database; creates and populates a new instance." />

    <target name="test" 
        depends="test:unit,test:integration"
        description="Executes all unit and functional tests." />

    <target name="deploy"
        depends="deploy:jboss"
        description="Deploys the caIntegrator 2 application to JBoss." />

    <target name="static-analysis" description="Performs static analysis"
        depends="
        static-analysis:simian,
        static-analysis:pmd,
        static-analysis:checkstyle,
        static-analysis:javancss,
        static-analysis:findbugs
        ">
            <fail if="checkstyle.failure" message="There were Checkstyle failures." />
            <fail if="pmd.failure" message="There were PMD failures." />
    </target>

    

    <target name="svn:getinfo" description="obtain subversion revision info" unless="nosvn">

            <echo message="svn:info" />
            <var name="revision" value="BASE"/>
            <echo>Local root directory: ${root.dir}</echo>
    
            <!-- find out revision number of BASE, need svn.exe installed on local machine -->
            <exec executable="svn" outputproperty="svnlog.out">
                <arg line="log ${root.dir}/software -r ${revision} -q"/>
            </exec>
    
            <!-- need ant-contrib.jar for this in lib dir of ant install -->
            <propertyregex property="svn.revision" input="${svnlog.out}" select="\1" defaultValue="Unknown">
                <regexp pattern="r([0-9]*)"/>
            </propertyregex>
            
            <echo message="Using svn revison tag: ${revision}." />
            <propertyregex property="caintegrator2.version" input="${svn.url}" regexp="\/([^\/]+)$" select="\1" casesensitive="false" />
            <echo message="svn url: ${svn.url}" />
            <echo message="repository revision: ${svn.revision}  caI2 version: ${caintegrator2.version}" />            
            
    </target>
     

    
    <!-- ******************************************************************* -->
    <!-- ** EXTERNAL DEPENDENCY PROPERTIES                                ** -->
    <!-- ******************************************************************* -->
    
    <property name="genepattern-service.jar.dir" location="${software.dir}/genepattern-service-jar" />
    <property name="genepattern-service.jar.target.dir" location="${genepattern-service.jar.dir}/target" />
    <property name="genepattern-service.jar" location="${genepattern-service.jar.target.dir}/genepattern-service.jar" />
    <property name="genepattern-service.jar.compile.lib.dir" location="${genepattern-service.jar.dir}/lib/compile"/>

    <property name="kaplan-meier.jar.dir" location="${software.dir}/kaplan-meier-jar" />
    <property name="kaplan-meier.jar.target.dir" location="${kaplan-meier.jar.dir}/target" />
    <property name="kaplan-meier.jar" location="${kaplan-meier.jar.target.dir}/kaplan-meier.jar" />
    <property name="kaplan-meier.jar.compile.lib.dir" location="${kaplan-meier.jar.dir}/lib/compile"/>    
    

    <!-- ******************************************************************* -->
    <!-- ** CAINTEGRATOR2.WAR                                             ** -->
    <!-- ******************************************************************* -->

    <property name="caintegrator2.war.dir" location="${software.dir}/caintegrator2-war" />
    <property name="caintegrator2.war.java.src.dir" location="${caintegrator2.war.dir}/src" />
    <property name="caintegrator2.war.resources.src.dir" location="${caintegrator2.war.dir}/resources" />
    <property name="caintegrator2.war.web.src.dir" location="${caintegrator2.war.dir}/web" />
    <property name="caintegrator2.war.test.src.dir" location="${caintegrator2.war.dir}/test/src" />
    <property name="caintegrator2.war.resources.test.dir" location="${caintegrator2.war.dir}/test/resources" />
    <property name="caintegrator2.war.target.dir" location="${caintegrator2.war.dir}/target" />
    <property name="caintegrator2.war.java.classes.dir" location="${caintegrator2.war.target.dir}/classes" />
    <property name="caintegrator2.war.instrumented.unit.classes.dir" location="${caintegrator2.war.target.dir}/instrumented-classes/unit" />
    <property name="caintegrator2.war.instrumented.integration.classes.dir" location="${caintegrator2.war.target.dir}/instrumented-classes/integration" />
    <property name="caintegrator2.war.test.classes.dir" location="${caintegrator2.war.target.dir}/test-classes" />
    <property name="caintegrator2.war" location="${caintegrator2.war.target.dir}/caintegrator2.war" />

    <target name="path:caintegrator2.war.dependencies" depends="ivy:setup-compile">
        <path id="caintegrator2.war.dependencies.path">
            <pathelement location="${caintegrator2.war.java.classes.dir}" />
            <pathelement location="${genepattern-service.jar}" />
            <pathelement location="${kaplan-meier.jar}" />
            <fileset dir="${caintegrator2.war.compile.lib.dir}">
                <include name="*.jar" />
                <exclude name="log4j*.jar" />
            </fileset>
            <fileset dir="${external.runtime.lib.dir}">
                <include name="*.jar" />
            </fileset>
            <fileset dir="${genepattern-service.jar.compile.lib.dir}">
                <include name="*.jar" />
            </fileset>
            <fileset dir="${kaplan-meier.jar.compile.lib.dir}">
                <include name="*.jar" />
            </fileset>
        </path>
    </target>

    <target name="path:caintegrator2.war.test.dependencies" depends="path:caintegrator2.war.dependencies,ivy:setup-test">
        <path id="caintegrator2.war.test.dependencies.path">
            <pathelement location="${caintegrator2.war.test.classes.dir}" />
            <path refid="caintegrator2.war.dependencies.path" />
            <pathelement location="${caintegrator2.war.resources.src.dir}" />        
            <pathelement location="${caintegrator2.war.resources.test.dir}" />
            <path refid="junit.classpath" />
        </path>        
        <property name="caintegrator2.war.test.dependencies.path" refid="caintegrator2.war.test.dependencies.path" />
    </target>
    
    <target name="clean:caintegrator2.war">
        <delete dir="${caintegrator2.war.target.dir}" />
    </target>
    
    <property name="web-inf.working.dir" location="${caintegrator2.war.target.dir}" />
    
    <target name="caintegrator2.war" depends="svn:getinfo,ivy:setup-runtime,compile:caintegrator2.war,caintegrator2.csm.xml.deploy,hibernate.cfg.xml.deploy">
        
        <copy todir="${web-inf.working.dir}" filtering="true" overwrite="true">
            <fileset dir="${caintegrator2.war.web.src.dir}/WEB-INF">
                <include name="web.xml"/>
            </fileset>    
            <filterset>
                <filter token="caintegrator2.version" value="${caintegrator2.version}" />
                <filter token="svn.url" value="${svn.url}"/>
                <filter token="svn.revision" value="${svn.revision}"/>
            </filterset>
        </copy>
        
        <war destfile="${caintegrator2.war}" webxml="${web-inf.working.dir}/web.xml">
            <fileset dir="${caintegrator2.war.web.src.dir}">
                <exclude name="WEB-INF/**" />
            </fileset>
            <lib dir="${caintegrator2.war.runtime.lib.dir}" includes="*.jar"> 
                <exclude name="log4j*.jar"/>
            </lib>
            <lib dir="${genepattern-service.jar.target.dir}" includes="*.jar"/> 
            <lib dir="${genepattern-service.jar.compile.lib.dir}" includes="*.jar"> 
                <exclude name="activation-1.0.2.jar"/>
            </lib>
            <lib dir="${kaplan-meier.jar.target.dir}" includes="*.jar"/> 
            <lib dir="${kaplan-meier.jar.compile.lib.dir}" includes="*.jar"> 
                <exclude name="log4j*.jar"/>
            </lib>
            <lib dir="${external.runtime.lib.dir}" includes="*.jar"/>
            <classes dir="${caintegrator2.war.java.classes.dir}" />
            <classes dir="${caintegrator2.war.resources.src.dir}">
                <exclude name="*hibernate.cfg.xml" />
            </classes>
            <webinf dir="${caintegrator2.war.resources.src.dir}">
                <include name="tiles.xml"/>
            </webinf>
            <webinf dir="${caintegrator2.war.web.src.dir}/WEB-INF">
                <exclude name="web.xml"/>
            </webinf>
        </war>
    </target>

    <target name="compile:caintegrator2.war" depends="path:caintegrator2.war.dependencies">
        <mkdir dir="${caintegrator2.war.java.classes.dir}" />
        <javac srcdir="${caintegrator2.war.java.src.dir}" destdir="${caintegrator2.war.java.classes.dir}" classpathref="caintegrator2.war.dependencies.path" debug="true" />
    </target>

    <target name="test:unit:caintegrator2.war" depends="test:compile:caintegrator2.war.test.classes,test:instrument:unit:caintegrator2.war,test:unpack-test-data">
        <run-junit-tests test.src.dir="${caintegrator2.war.test.src.dir}" 
            xml.output.dir="${caintegrator2.war.target.dir}/junit" 
            instrumented.classes="${caintegrator2.war.instrumented.unit.classes.dir}" 
            classpath="${caintegrator2.war.test.dependencies.path}" />
    </target>

    <target name="test:unpack-test-data">
        <for param="zipfile">
            <path>
                <fileset dir="${caintegrator2.war.resources.test.dir}" includes="**/*.zip" />
            </path>
            <sequential>
                <unzip overwrite="false" src="@{zipfile}" dest="@{zipfile}/.." />
            </sequential>
        </for>
    </target>

    <target name="test:integration:caintegrator2.war" depends="test:compile:caintegrator2.war.test.classes,
        test:instrument:integration:caintegrator2.war,
        hibernate.cfg.xml.test,
        database:reinitialize">
        <run-integration-junit-tests test.src.dir="${caintegrator2.war.test.src.dir}" 
            xml.output.dir="${caintegrator2.war.target.dir}/junit" 
            instrumented.classes="${caintegrator2.war.instrumented.integration.classes.dir}" 
            classpath="${caintegrator2.war.test.dependencies.path}" />
    </target>
    
    <target name="test:integration:master.build" depends="test:compile:caintegrator2.war.test.classes,
        test:instrument:integration:caintegrator2.war,
        hibernate.cfg.xml.test">
        <run-integration-junit-tests test.src.dir="${caintegrator2.war.test.src.dir}" 
            xml.output.dir="${caintegrator2.war.target.dir}/junit" 
            instrumented.classes="${caintegrator2.war.instrumented.integration.classes.dir}" 
            classpath="${caintegrator2.war.test.dependencies.path}" />
    </target>
    
    <target name="test:instrument:unit:caintegrator2.war" depends="compile:caintegrator2.war,ivy:setup-test">
         <cobertura-instrument todir="${caintegrator2.war.instrumented.unit.classes.dir}" datafile="${cobertura.file}">
             <fileset  dir="${caintegrator2.war.java.classes.dir}">
                 <include name="gov/nih/nci/caintegrator2/**" />
                 <!-- Excludes for classes that can only be tested in integration tests -->
                 <exclude name="gov/nih/nci/caintegrator2/data/CaIntegrator2DaoImpl.class" />
                 <exclude name="gov/nih/nci/caintegrator2/external/ncia/NCIASearchServiceImpl.class" />
                 <exclude name="gov/nih/nci/caintegrator2/external/ncia/NCIAServiceFactoryImpl.class" />
                 <exclude name="gov/nih/nci/caintegrator2/external/ncia/NCIADicomJobRunnerImpl.class" />
                 <exclude name="gov/nih/nci/caintegrator2/common/GenericEnumUserType.class" />
                 <exclude name="gov/nih/nci/caintegrator2/common/ConfigurationHelperImpl.class" />
             </fileset>
         </cobertura-instrument>
     </target>
    
    <target name="test:instrument:integration:caintegrator2.war" depends="compile:caintegrator2.war,ivy:setup-test">
         <cobertura-instrument todir="${caintegrator2.war.instrumented.integration.classes.dir}" datafile="${cobertura.file}">
             <fileset dir="${caintegrator2.war.java.classes.dir}">
                 <include name="gov/nih/nci/caintegrator2/**" />
             </fileset>
         </cobertura-instrument>
     </target>

    <target name="test:compile:caintegrator2.war.test.classes" depends="compile:caintegrator2.war,path:caintegrator2.war.test.dependencies">
        <mkdir dir="${caintegrator2.war.test.classes.dir}" />
        <javac srcdir="${caintegrator2.war.test.src.dir}" destdir="${caintegrator2.war.test.classes.dir}" classpathref="caintegrator2.war.test.dependencies.path" debug="true" />
    </target>


    <!-- ******************************************************************* -->
    <!-- ** DATABASE TARGETS                                              ** -->
    <!-- ******************************************************************* -->
    
    <property name="caintegrator2db.dir" location="${software.dir}/common/resources/db-install/mysql" />
    <property name="caintegrator2db.sql.src.dir" location="${caintegrator2db.dir}" />
    <property name="caintegrator2db.sql.target.dir" location="${caintegrator2db.dir}/target/sql" />
    <property name="comment.start" value="&lt;!-- " />
    <property name="comment.end" value=" -->" />

    <target name="database:init-sql">
        <mkdir dir="${caintegrator2db.sql.target.dir}" />
        <copy todir="${caintegrator2db.sql.target.dir}">
            <filterset refid="caintegrator2.filterset" />
            <fileset dir="${caintegrator2db.sql.src.dir}" includes="*.sql" />
        </copy>
    </target>

    <target name="database:drop-tables" description="Drop caIntegrator 2 schema">
        <run-sql-script onerror="continue" sql.file="${caintegrator2db.sql.target.dir}/drop-main-tables.sql" />
        <run-sql-script onerror="continue" sql.file="${caintegrator2db.sql.target.dir}/drop-supporting-tables.sql" />
	  <run-sql-script onerror="continue" sql.file="${caintegrator2db.sql.target.dir}/drop-csm-tables.sql" />
    </target>

    <target name="database:create-tables" description="Create caIntegrator 2 schema">
        <run-sql-script sql.file="${caintegrator2db.sql.target.dir}/create-main-tables.sql" />
        <run-sql-script sql.file="${caintegrator2db.sql.target.dir}/create-supporting-tables.sql" />
	  <run-sql-script sql.file="${caintegrator2db.sql.target.dir}/create-csm-tables.sql" />
	  <run-sql-script sql.file="${caintegrator2db.sql.target.dir}/prime-csm-tables.sql" />
    </target>

    <target name="database:create-tables-generated" depends="database:generate-sql">
        <run-sql-script sql.file="${caintegrator2db.sql.target.dir}/create-tables-generated.sql" />
    </target>

    <target name="database:reinitialize-tables" depends="database:drop-tables,database:create-tables" description="Drop &amp; recreate caIntegrator 2 schema" />

    <target name="database:reinitialize" depends="database:init-sql" description="Completely reset caIntegrator 2 by dropping database, recreating, and creating schema, and populating with initial data">
        <antcall target="database:recreate-database" />
        <antcall target="database:create-tables" />
    </target>

        <target name="database:reinitialize-generated" depends="database:init-sql" description="Completely reset caIntegrator 2 by dropping database, recreating, and creating schema (from generated files), and populating with initial data">
            <antcall target="database:recreate-database" />
            <antcall target="database:create-tables-generated" />
        </target>

    <target name="database:recreate-database" description="Drops and recreates caintegrator2 database">
        <run-sql-script database.url="${database.system.url}" 
            database.user="${database.system.user}" 
            database.password="${database.system.password}" 
            sql.file="${caintegrator2db.sql.target.dir}/create-database-and-user.sql" />
    </target>

    <target name="database:generate-sql" depends="compile:caintegrator2.war, database:init-sql">
        <hibernatetool destdir="${caintegrator2db.sql.target.dir}">
            <configuration configurationfile="${caintegrator2.war.resources.src.dir}/hibernate.cfg.xml" />
            <hbm2ddl drop="false" create="true" export="false" outputfilename="create-tables-generated.sql" />
            <hbm2ddl drop="true" create="false" export="false" outputfilename="drop-tables-generated.sql" />
            <classpath>
                <pathelement location="${caintegrator2.war.java.classes.dir}" />
                <pathelement location="${caintegrator2.war.resources.src.dir}" />
            </classpath>
        </hibernatetool>
    </target>
    
    <target name="database:test-data" depends="database:reinitialize,test:compile:caintegrator2.war.test.classes,hibernate.cfg.xml.test">
        <java classname="gov.nih.nci.caintegrator2.data.DataGenerator" classpathref="caintegrator2.war.test.dependencies.path" />
    </target>
    
    <property name="hibernate.cfg.xml.src" value="${caintegrator2.war.resources.src.dir}/hibernate.cfg.xml" />
    <property name="hibernate.cfg.xml.test" value="${caintegrator2.war.test.classes.dir}/hibernate.cfg.xml" />
    <property name="hibernate.cfg.xml.deploy" value="${caintegrator2.war.java.classes.dir}/hibernate.cfg.xml" />

    <target name="hibernate.cfg.xml.test">
        <copy file="${hibernate.cfg.xml.src}" tofile="${hibernate.cfg.xml.test}" overwrite="true">
            <filterset refid="caintegrator2.filterset" />
            <filterset>
                <filter token="HIBERNATE_CONFIG_START" value="${comment.end}" />
                <filter token="HIBERNATE_CONFIG_END" value="${comment.start}" />
            </filterset>
        </copy>
    </target>

    <target name="hibernate.cfg.xml.deploy">
        <copy file="${hibernate.cfg.xml.src}" tofile="${hibernate.cfg.xml.deploy}" overwrite="true">
            <filterset refid="caintegrator2.filterset" />
            <filterset>
                <filter token="DATASOURCE_CONFIG_START" value="${comment.end}" />
                <filter token="DATASOURCE_CONFIG_END" value="${comment.start}" />
            </filterset>
        </copy>
    </target>
    

    <property name="caintegrator2.csm.xml.src" value="${caintegrator2.war.resources.src.dir}/caintegrator2.csm.new.hibernate.cfg.xml" />
    <property name="caintegrator2.csm.xml.deploy" value="${caintegrator2.war.java.classes.dir}/caintegrator2.csm.new.hibernate.cfg.xml" />

    <target name="caintegrator2.csm.xml.deploy">
        <copy file="${caintegrator2.csm.xml.src}" tofile="${caintegrator2.csm.xml.deploy}" overwrite="true">
            <filterset refid="caintegrator2.filterset" />
            <filterset>
                <filter token="DATASOURCE_CONFIG_START" value="${comment.end}" />
                <filter token="DATASOURCE_CONFIG_END" value="${comment.start}" />
            </filterset>
        </copy>
    </target>

    <!-- ******************************************************************* -->
    <!-- ** CLASSPATHS                                                    ** -->
    <!-- ******************************************************************* -->

    <path id="caintegrator2.full.classpath">
        <path refid="caintegrator2.war.dependencies.path" />
        <pathelement location="${caintegrator2.war.java.classes.dir}" />
    </path>

    <!-- ******************************************************************* -->
    <!-- ** TEST TARGETS                                                  ** -->
    <!-- ******************************************************************* -->

    <!-- JUnit Test Targets -->
    <target name="test:unit" depends="test:unit:caintegrator2.war,
      test:junit-report,
      test:cobertura-report,
      test:cobertura-check">
        <fail if="junit.failure" message="There were JUnit failures." />
        <fail if="cobertura.failure" message="Test coverage was insufficient (see Cobertura report)." />
    </target>

    <target name="test:integration" depends="test:integration:caintegrator2.war,
        test:junit-report-integration">
        <fail if="junit.failure" message="There were JUnit failures." />
    </target>
    
    <target name="test:integration:from-master" depends="test:integration:master.build,
        test:junit-report-integration">
        <fail if="junit.failure" message="There were JUnit failures." />
    </target>
 
    <target name="test:junit-report">
        <mkdir dir="${reports.dir}/junit/unit" />
        <junitreport todir="${reports.dir}/junit/unit">
            <fileset dir="${caintegrator2.war.target.dir}/junit">
                <include name="TEST-*.xml" />
            </fileset>
            <report format="frames" todir="${reports.dir}/junit/unit" />
        </junitreport>
    </target>

    <target name="test:junit-report-integration">
        <mkdir dir="${reports.dir}/junit/integration" />
        <junitreport todir="${reports.dir}/junit/integration">
            <fileset dir="${caintegrator2.war.target.dir}/junit">
                <include name="TEST-*.xml" />
            </fileset>
            <report format="frames" todir="${reports.dir}/junit/integration" />
        </junitreport>
    </target>

    <!-- Cobertura Test Targets -->
    <target name="test:cobertura-report" depends="ivy:setup-test">
        <cobertura-report format="xml" destdir="${cobertura.dir}/unit" datafile="${cobertura.file}">
            <fileset dir="${caintegrator2.war.java.src.dir}" />
        </cobertura-report>
        <cobertura-report format="html" destdir="${cobertura.dir}/unit" datafile="${cobertura.file}">
            <fileset dir="${caintegrator2.war.java.src.dir}" />
        </cobertura-report>
    </target>

    <target name="test:cobertura-check" depends="ivy:setup-test">
        <cobertura-check failureproperty="cobertura.failure" datafile="${cobertura.file}" haltonfailure="false" linerate="0" packagebranchrate="0" packagelinerate="0" totalbranchrate="69" totallinerate="80" />
    </target>

    <!-- ******************************************************************* -->
    <!-- ** STATIC ANALYSIS TARGETS                                       ** -->
    <!-- ******************************************************************* -->

    <!-- Creates paths and  directories -->
    <target name="clean:reports">
        <delete dir="${reports.dir}"/>
    </target>

    <!-- One target and one macro have been written for each static-analysis tool.  The macro runs static-analysis on an one set of values. The target then calls the macro with values for each sub-project.  If a user wanted to add options to the static-analysis tool in the the macro, they could add an attribute, refer to that attribute in the static-analysis call and then add the option to each of the calls to the marco in the wrapper target.-->

    <!-- Findbugs is realy a full application that has ant support.  This target downloads the binaries for this distribution for use by ant target.  Additionaly setups a jboss installation to uses in the classpath of findbugs to cover runtime libraries -->
    <target name="static-analysis:findbugs-init" >
        <mkdir dir="${reports.findbugs.dir}"/>
        <property name="temp.dir" value="${software.dir}/temp"/>
        <mkdir dir="${temp.dir}"/>
        <property name="findbugs.home.dir" value="${lib.dir}/${findbugs.binaries.relative.dir}"/>
        <if>
            <not>
                <available file="${findbugs.home.dir}/lib/findbugs.jar"/>
            </not>
            <then>
                <echo message="Findbugs is missing, downloading and isnstalling in ${findbugs.home.dir}"/>
                <get src="${findbugs.src.url}"
                    dest="${temp.dir}/${findbugs.binaries.file}"/>
                <unzip dest="${lib.dir}" src="${temp.dir}/${findbugs.binaries.file}" />
            </then>
        </if>
        <path id="project.test.findbugs.classpath">
            <fileset dir="${findbugs.home.dir}">
                <include name="**/*.jar" />
            </fileset>
        </path>
    </target>

    <!-- Runs Simian a code duplication reporter.
        You can find additional information about simian at:
        http://www.redhillconsulting.com.au/products/simian/installation.html
        -->
    <target name="static-analysis:simian" depends="ivy:setup-static-analysis" description="Performs code duplication analysis">
        <mkdir dir="${reports.simian.dir}"/>
        <static-analysis-simian
            simian.src.dir="${caintegrator2.war.java.src.dir}"
            simian.rpt.dir="${reports.simian.dir}"
            simian.report-xsl.file="${common.dir}/simian/simian.xsl"
            simian.xml.name="simian-caintegrator2-war.xml"
            simian.html.name="simian-caintegrator2-war.html"
            />
    </target>

    <target name="static-analysis:pmd" depends="ivy:setup-static-analysis">
        <mkdir dir="${reports.pmd.dir}"/>
        <static-analysis-pmd
            pmd.src.dir="${caintegrator2.war.java.src.dir}"
            pmd.rpt.dir="${reports.pmd.dir}"
            pmd.root-dir.name="software"
            pmd.sub-project.name="caintegrator2-war"
            pmd.report-xsl.file="${common.dir}/pmd/pmd-report-per-class.xslt"
            pmd.report-preprocessor.file="${common.dir}/pmd/pmd-hudson-preprocessor.xlst"
            pmd.rule-set.file="${common.dir}/pmd/pmd-ruleset.xml"
            pmd.xml.name="pmd-report.xml"
            pmd.html.name="pmd-report.html"
            />
    </target>

    <!-- Runs JavaNCSS a tool that identifies code Cyclomatic Complexity.
        You can find additional information about JavaNCSS at:
        http://www.kclee.de/clemens/java/javancss/
        -->
    <target name="static-analysis:javancss" depends="ivy:setup-static-analysis">
        <mkdir dir="${reports.javancss.dir}"/>
        <static-analysis-javancss
            javancss.src.dir="${caintegrator2.war.java.src.dir}"
            javancss.rpt.dir="${reports.javancss.dir}"
            javancss.report-xsl.file="${common.dir}/javancss/javancss2methodhtml.xsl"
            javancss.xml.name="javancss_metrics_caintegrator2-war.xml"
            javancss.html.name="javancss_report_caintegrator2-war.html"
            />
    </target>

    <!-- Runs CheckStyle is a codeing standard violation reporter.  
        You can find additional information about checkstyle at:
        http://checkstyle.sourceforge.net/
        -->
    <target name="static-analysis:checkstyle" depends="ivy:setup-static-analysis">
        <mkdir dir="${reports.checkstyle.dir}"/>
        <static-analysis-checkstyle
            checkstyle.src.dir="${caintegrator2.war.java.src.dir}"
            checkstyle.rpt.dir="${reports.checkstyle.dir}"
            checkstyle.report-xsl.file="${common.dir}/checkstyle/checkstyle-frames.xsl"
            checkstyle.config.file="${checkstyle.config}"
            checkstyle.xml.name="checkstyle.xml"
            checkstyle.html.name="checkstyle.html"
            checkstyle.classpath.ref.name="caintegrator2.full.classpath"
            />
    </target>

    <!-- Runs Findbugs a tool that attempts to find bugs.
        You can find additional information about findbugs at:
        http://findbugs.sourceforge.net/
        -->
    <target name="static-analysis:findbugs" 
        depends="
        caintegrator2.war,
        ivy:setup-static-analysis,
        static-analysis:findbugs-init">
        <mkdir dir="${reports.findbugs.dir}/caintegrator2"/>

        <static-analysis-findbugs
            findbugs.home.dir="${findbugs.home.dir}"
            findbugs.src.dir="${caintegrator2.war.java.src.dir}"
            findbugs.classes.dir="${caintegrator2.war.java.classes.dir}"
            findbugs.rpt.dir="${reports.findbugs.dir}/caintegrator2"
            findbugs.report-xsl.file="${findbugs.home.dir}/src/xsl/fancy.xsl"
            findbugs.app.classpath.ref="caintegrator2.full.classpath" 
            findbugs.xml.name="findbugs.xml"
            findbugs.html.name="findbugs.html"
            />
    </target>

    <target name="pmd:update-eclipse-projects">
        <copy file="${resource.dir}/pmd/pmd-ruleset.xml" tofile="${root.dir}/.ruleset" />
    </target>

    <!-- ******************************************************************* -->
    <!-- ** DEPLOYMENT TARGETS                                            ** -->
    <!-- ******************************************************************* -->
    
    <property name="jboss.home" location="${env.JBOSS_HOME}" />
    <property name="jboss.server.name" value="default" />
    <property name="jboss.server.dir" location="${jboss.home}/server/${jboss.server.name}" />
    <property name="jboss.deploy.dir" location="${jboss.server.dir}/deploy" />
    <property name="caintegrator2.datasource" location="${software.dir}/common/resources/jboss-conf/caintegrator2-mysql-ds.xml" />
    <property name="caintegrator2.jms.destinations.file" location="${software.dir}/common/resources/jboss-conf/caintegrator2-jms-destinations-service.xml" />
    
    <target name="deploy:jboss" depends="caintegrator2.war">
        <copy file="${caintegrator2.datasource}" todir="${jboss.deploy.dir}">
            <filterset refid="caintegrator2.filterset" />
        </copy>
        <copy file="${caintegrator2.jms.destinations.file}" todir="${jboss.deploy.dir}/jms" />
        <copy file="${caintegrator2.war.compile.lib.dir}/mysql-connector-java-5.0.5.jar" todir="${jboss.server.dir}/lib" />
        <copy file="${caintegrator2.war}" todir="${jboss.deploy.dir}" />
    </target>

    <target name="deploy:jsp" description="Copies all current JSP code to the deployed application for quick update">
        <for param="toDir">
            <path>
                <dirset dir="${jboss.deploy.dir}/../tmp/deploy" includes="tmp*caintegrator2-exp.war" />
            </path>
            <sequential>
                <copy todir="@{toDir}">
                    <fileset dir="${caintegrator2.war.web.src.dir}">
                        <include name="**/*.jsp" />
                        <include name="**/*.jspf" />
                        <include name="**/*.css" />
                        <include name="**/*.js" />
                        <include name="**/*.jpg" />
                        <include name="**/*.gif" />
                        <include name="**/*.png" />
                        <include name="**/*.faces" />
                        <include name="**/*.tag" />
                        <include name="**/*.tagf" />
                    </fileset>
                </copy>
            </sequential>
        </for>
    </target>

    <target name="deploy:vasari" depends="test:compile:caintegrator2.war.test.classes,
        caintegrator2.war,
        hibernate.cfg.xml.test,
        database:reinitialize">
        <junit printsummary="on" failureproperty="junit.failure" fork="true" forkmode="once" maxmemory="1024m">
             <classpath>
                 <pathelement path="${caintegrator2.war.test.dependencies.path}" />
             </classpath>
             <formatter type="xml" />
             <batchtest todir="${caintegrator2.war.target.dir}/junit">
                 <fileset dir="${caintegrator2.war.test.src.dir}">
                     <include name="**/DeployVasariTestIntegration.java" />
                 </fileset>
             </batchtest>
         </junit>
    </target>

    <target name="deploy:dc-lung" depends="test:compile:caintegrator2.war.test.classes,
        caintegrator2.war,
        hibernate.cfg.xml.test,
        database:reinitialize">
        <junit printsummary="on" failureproperty="junit.failure" fork="true" forkmode="once" maxmemory="1024m">
             <classpath>
                 <pathelement path="${caintegrator2.war.test.dependencies.path}" />
             </classpath>
             <formatter type="xml" />
             <batchtest todir="${caintegrator2.war.target.dir}/junit">
                 <fileset dir="${caintegrator2.war.test.src.dir}">
                     <include name="**/DeployDCLungStudyTestIntegration.java" />
                 </fileset>
             </batchtest>
         </junit>
    </target>
    
    <target name="deploy:rembrandt-ncri" depends="test:compile:caintegrator2.war.test.classes,
        caintegrator2.war,
        hibernate.cfg.xml.test,
        database:reinitialize">
        <junit printsummary="on" failureproperty="junit.failure" fork="true" forkmode="once" maxmemory="1024m">
             <classpath>
                 <pathelement path="${caintegrator2.war.test.dependencies.path}" />
             </classpath>
             <formatter type="xml" />
             <batchtest todir="${caintegrator2.war.target.dir}/junit">
                 <fileset dir="${caintegrator2.war.test.src.dir}">
                     <include name="**/DeployStudyRembrandtNcriTestIntegration.java" />
                 </fileset>
             </batchtest>
         </junit>
    </target>
    

    <!-- ******************************************************************* -->
    <!-- ** DOCUMENTATION TARGETS                                         ** -->
    <!-- ******************************************************************* -->

    <target name="javadoc" depends="javadoc:full" description="Generates javadoc for all source code" />

    <target name="javadoc:full">
        <mkdir dir="${reports.dir}/docs/api" />
        <javadoc destdir="${reports.dir}/docs/api" classpathref="caintegrator2.full.classpath">
            <packageset dir="${caintegrator2.war.java.src.dir}" />
        </javadoc>
    </target>

    
    <!-- ******************************************************************* -->
    <!-- ** MACRODEFS                                                     ** -->
    <!-- ******************************************************************* -->

    <macrodef name="run-integration-junit-tests">
        <attribute name="test.src.dir" />
        <attribute name="xml.output.dir" />
        <attribute name="classpath" default="" />
        <attribute name="instrumented.classes" default="" />

        <sequential>
            <mkdir dir="@{xml.output.dir}" />
            <junit printsummary="on" failureproperty="junit.failure" fork="true" forkmode="once" maxmemory="1024m">
                <sysproperty key="net.sourceforge.cobertura.datafile" file="${cobertura.file}" />
                <sysproperty key="server.hostname" value="${jboss.server.hostname}" />
                <sysproperty key="server.port" value="${jboss.server.port}" />
                <sysproperty key="server.jndi.port" value="${jboss.server.jndi.port}" />
                <sysproperty key="selenium.server.port" value="${selenium.server.port}" />

                <classpath>
                    <pathelement path="@{instrumented.classes}" />
                    <pathelement path="@{classpath}" />
                    <path refid="cobertura.classpath" />
                </classpath>
                <formatter type="xml" />
                <batchtest todir="@{xml.output.dir}">
                    <fileset dir="@{test.src.dir}">
                        <include name="**/*TestIntegration.java" />
                        <exclude name="**/Abstract*TestIntegration.java" />
                    </fileset>
                </batchtest>
            </junit>
        </sequential>
    </macrodef>
    
    <macrodef name="static-analysis-simian">
        <attribute name="simian.src.dir"/>
        <attribute name="simian.rpt.dir"/>
        <attribute name="simian.report-xsl.file"/>
        <attribute name="simian.xml.name" default="simian.xml"/>
        <attribute name="simian.html.name" default="simian.html"/>
        <sequential>
            <taskdef resource="simiantask.properties" classpathref="project.test.simian.classpath" />
            <simian
                failureProperty="simian.failure"
                failOnDuplication="failse"
                >
                <fileset dir="@{simian.src.dir}" includes="**/*.java"/>
                <formatter type="xml" toFile="@{simian.rpt.dir}/@{simian.xml.name}"/>
            </simian>
            <xslt in="@{simian.rpt.dir}/@{simian.xml.name}" out="@{simian.rpt.dir}/@{simian.html.name}" style="@{simian.report-xsl.file}" />
        </sequential>
    </macrodef>

	<macrodef name="static-analysis-pmd">
		<attribute name="pmd.src.dir"/>
		<attribute name="pmd.rpt.dir"/>
		<attribute name="pmd.root-dir.name"/>
		<attribute name="pmd.sub-project.name"/>
		<attribute name="pmd.report-preprocessor.file"/>
		<attribute name="pmd.report-xsl.file"/>
		<attribute name="pmd.rule-set.file"/>
		<attribute name="pmd.xml.name" default="pmd.xml"/>
		<attribute name="pmd.html.name" default="pmd.html"/>
		<sequential>
			<property name="pmd.sub-project.rpt.dir" value="@{pmd.rpt.dir}/@{pmd.sub-project.name}/target"/>
			<mkdir dir="${pmd.sub-project.rpt.dir}"/>
			<taskdef name="pmd" 
				classname="net.sourceforge.pmd.ant.PMDTask"
				classpathref="project.test.pmd.classpath"/>
			<pmd 
				rulesetfiles="@{pmd.rule-set.file}"
				shortFilenames="true" 
				failonerror="false"
				failurespropertyname="pmd.failure"
				targetjdk="1.5"
				>
				<formatter type="xml"
					toFile="${pmd.sub-project.rpt.dir}/@{pmd.xml.name}" />
				<fileset dir="@{pmd.src.dir}">
					<include name="**/*.java"/>
				</fileset>
			</pmd>
			<move file="${pmd.sub-project.rpt.dir}/@{pmd.xml.name}" tofile="${pmd.sub-project.rpt.dir}/@{pmd.xml.name}.bak"/>
			<xslt taskname="pmd"
				in="${pmd.sub-project.rpt.dir}/@{pmd.xml.name}.bak"
				out="${pmd.sub-project.rpt.dir}/@{pmd.xml.name}"
				style="@{pmd.report-preprocessor.file}">
				<param name="relative.path" expression="@{pmd.root-dir.name}/@{pmd.sub-project.name}"/>
			</xslt>

			<xslt taskname="pmd"
				in="${pmd.sub-project.rpt.dir}/@{pmd.xml.name}.bak"
				out="${pmd.sub-project.rpt.dir}/@{pmd.html.name}"
				style="@{pmd.report-xsl.file}"/>
		</sequential>
	</macrodef>

	<macrodef name="static-analysis-javancss">
		<attribute name="javancss.src.dir"/>
		<attribute name="javancss.rpt.dir"/>
		<attribute name="javancss.report-xsl.file"/>
		<attribute name="javancss.xml.name" default="javancss.xml"/>
		<attribute name="javancss.html.name" default="javancss.html"/>
		<sequential>
			<taskdef name="javancss" classpathref="javancss.classpath" classname="javancss.JavancssAntTask" />
			<javancss
				srcdir="@{javancss.src.dir}"
				includes="**/*.java"
				excludes="**/*test*/*"
				generatereport="true"
				outputfile="@{javancss.rpt.dir}/@{javancss.xml.name}"
				ccnPerFuncMax="10"
				format="xml">
			</javancss>
			<xslt taskname="javancss"
				in="@{javancss.rpt.dir}/@{javancss.xml.name}"
				out="@{javancss.rpt.dir}/@{javancss.html.name}"
				style="@{javancss.report-xsl.file}"/>
		</sequential>
	</macrodef>

	<macrodef name="static-analysis-findbugs">
		<attribute name="findbugs.home.dir"/>
		<attribute name="findbugs.src.dir"/>
		<attribute name="findbugs.rpt.dir"/>
		<attribute name="findbugs.classes.dir"/>
		<attribute name="findbugs.report-xsl.file"/>
		<attribute name="findbugs.app.classpath.ref"/>
		<attribute name="findbugs.xml.name" default="findbugs.xml"/>
		<attribute name="findbugs.html.name" default="findbugs.html"/>
		<sequential>
			<taskdef name="findbugs" classname="edu.umd.cs.findbugs.anttask.FindBugsTask" classpathref="project.test.findbugs.classpath"/>

			<findbugs home="@{findbugs.home.dir}"
				output="xml:withMessages"
				outputFile="@{findbugs.rpt.dir}/@{findbugs.xml.name}"
				jvmargs="-Xms128m -Xmx512m"
				>
				<auxClasspath>
					<!--
					<fileset dir="@{findbugs.app.classpath.dir}">
						<include name="**/*.jar" />
					</fileset>
					-->
					<fileset refid="@{findbugs.app.classpath.ref}"/>
				</auxClasspath>

				<sourcePath path="@{findbugs.src.dir}" />
				<class location="@{findbugs.classes.dir}" />
			</findbugs>
			<xslt taskname="findbugs"
				in="@{findbugs.rpt.dir}/@{findbugs.xml.name}"
				out="@{findbugs.rpt.dir}/@{findbugs.html.name}"
				style="@{findbugs.report-xsl.file}"
				/>
		</sequential>
	</macrodef>

	<macrodef name="static-analysis-checkstyle">
		<attribute name="checkstyle.src.dir"/>
		<attribute name="checkstyle.rpt.dir"/>
		<attribute name="checkstyle.report-xsl.file"/>
		<attribute name="checkstyle.config.file"/>
		<attribute name="checkstyle.xml.name" default="checkstyle.xml"/>
		<attribute name="checkstyle.html.name" default="checkstyle.html"/>
		<attribute name="checkstyle.classpath.ref.name" />
		<sequential>
			<taskdef resource="checkstyletask.properties"
				uri="antlib:com.puppycrawl.tools.checkstyle"
				classpathref="project.test.checkstyle.classpath"/>
			<cs:checkstyle config="@{checkstyle.config.file}"
				failureProperty="checkstyle.failure" 
				failOnViolation="false"
				maxerrors="0" 
				maxwarnings="0"
				classpathref="@{checkstyle.classpath.ref.name}"
				>
				<formatter type="xml" 
					tofile="@{checkstyle.rpt.dir}/@{checkstyle.xml.name}"/>
				<fileset dir="@{checkstyle.src.dir}">
					<include name="**/*.java"/>
				</fileset>
			</cs:checkstyle>
			<xslt taskname="checkstyle"
				in="@{checkstyle.rpt.dir}/@{checkstyle.xml.name}"
				out="@{checkstyle.rpt.dir}/@{checkstyle.html.name}"
				style="@{checkstyle.report-xsl.file}"
				>
				<param name="output.dir" expression="@{checkstyle.rpt.dir}" />
			</xslt>

		</sequential>
	</macrodef>
    


</project>
